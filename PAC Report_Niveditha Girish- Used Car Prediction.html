library(tidyr)

analysis_data <- read.csv('/Users/nivedithagirish/Downloads/usedcars2023/analysisData.csv')
scoring_data <- read.csv('/Users/nivedithagirish/Downloads/usedcars2023/scoringData.csv')

#categorical and numerical variables
categorical_vars <- c('make_name', 'model_name', 'trim_name', 'body_type', 'fuel_type', 'transmission', 'wheel_system', 'exterior_color', 'major_options')
numerical_vars <- c('fuel_tank_volume_gallons', 'highway_fuel_economy', 'city_fuel_economy', 'wheelbase_inches', 'back_legroom_inches', 'length_inches', 'width_inches', 'height_inches', 'engine_displacement', 'horsepower', 'daysonmarket', 'maximum_seating', 'year', 'mileage', 'owner_count', 'seller_rating') # Add other numerical columns as necessary

# missing values for numerical columns
analysis_data[numerical_vars] <- lapply(analysis_data[numerical_vars], function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x))

# For categorical variables replace NA with "Unknown"
analysis_data[categorical_vars] <- lapply(analysis_data[categorical_vars], function(x) ifelse(is.na(x), 'Unknown', x))

# Convert categorical variables to factors
analysis_data <- analysis_data %>%
  mutate(across(all_of(categorical_vars), factor))

#preprocessing for scoring data
scoring_data[numerical_vars] <- lapply(scoring_data[numerical_vars], function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x))
scoring_data[categorical_vars] <- lapply(scoring_data[categorical_vars], function(x) ifelse(is.na(x), 'Unknown', x))

# Convert categorical variables in scoring data to factors
scoring_data <- scoring_data %>%
  mutate(across(all_of(categorical_vars), factor))

# Model Building
set.seed(608)
forest_ranger2 = ranger(price~make_name + model_name + trim_name + body_type + fuel_tank_volume_gallons + fuel_type + highway_fuel_economy + city_fuel_economy + power + torque + transmission  + transmission_display + wheel_system + wheelbase_inches + back_legroom_inches + engine_type + engine_displacement + horsepower + daysonmarket + exterior_color + major_options + maximum_seating + year + fleet + frame_damaged + has_accidents + isCab + is_new + mileage + owner_count + seller_rating,data = analysis_data, 
                        num.trees = 1500,mtry = 15)
## Growing trees.. Progress: 30%. Estimated remaining time: 1 minute, 12 seconds.
## Growing trees.. Progress: 60%. Estimated remaining time: 41 seconds.
## Growing trees.. Progress: 90%. Estimated remaining time: 10 seconds.
# Making Predictions
predictions <- predict(forest_ranger2, scoring_data)$predictions
scoring_data$price <- predictions

# Preparing Submission File
submission <- scoring_data[, c("id", "price")]
write.csv(submission, '/Users/nivedithagirish/Downloads/usedcars2023/submissionFile5555.csv', row.names = FALSE)
